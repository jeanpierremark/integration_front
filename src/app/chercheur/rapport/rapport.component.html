<div class="report-editor">
  <!-- Mode Aperçu -->
  <div *ngIf="previewMode" class="preview-mode">
    <div class="preview-header">
      <h1 class="preview-title">Aperçu du Rapport</h1>
      <div class="preview-actions">
        <button class="btn btn-primary " (click)="togglePreview()">
        <i class="bi bi-pencil-square"></i>
          Modifier
        </button>
        <button class="btn btn-success" (click)="exportToPDF()">
          <i class="bi bi-download"></i>
          Exporter PDF
        </button>
      </div>
    </div>
    
    <div class="preview-content">
      <div class="report-header">
        <h1 class="report-main-title">{{ report.title || 'Titre du Rapport' }}</h1>
        <h2 *ngIf="report.subtitle" class="report-subtitle">{{ report.subtitle }}</h2>
        <div class="report-meta">
          <span>Auteur: {{ report.author || 'Non spécifié' }}</span>
          <span>Date: {{ report.date }}</span>
          <span>Localisation: {{ report.location || 'Non spécifiée' }}</span>
        </div>
      </div>

      <div *ngIf="report.executive_summary" class="executive-summary">
        <h3 class="summary-title">Résumé Exécutif</h3>
        <div class="summary-content" [innerHTML]="formatTextWithMarkdown(report.executive_summary)"></div>
      </div>

      <div *ngFor="let section of report.sections; let i = index" class="report-section">
        <h3 class="section-title">{{ i + 1 }}. {{ section.title }}</h3>
        <div *ngIf="section.type === 'chart'; else textContent" class="chart-placeholder">
          <i class="bi bi-bar-chart chart-preview-icon"></i>
          <p>Graphique: {{ section.chartData?.title }}</p>
        </div>
        <ng-template #textContent>
          <div class="section-content" [innerHTML]="formatTextWithMarkdown(section.content || 'Contenu à rédiger...')"></div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Mode Édition -->
  <div *ngIf="!previewMode" class="editor-mode">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header bg-primary ">
        <h1 class="sidebar-title text-light">
          <i class="bi bi-file-earmark-text "></i>
          Éditeur de Rapport
        </h1>
        <p class="sidebar-subtitle">Données Climatiques</p>
      </div>

      <div class="sidebar-content">
        <!-- Informations générales -->
        <div class="form-group">
          <label class="form-label">Titre du Rapport</label>
          <input 
            type="text" 
            class="form-input"
            [(ngModel)]="report.title"
            placeholder="Analyse Climatique 2024"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Informations Générales</label>
          <div class="input-group">
            <input 
              type="text" 
              class="form-input-sm"
              [(ngModel)]="report.author"
              placeholder="Auteur"
            />
            <div class="input-with-icon">
              <i class="bi bi-geo-alt"></i>
              <input 
                type="text" 
                class="form-input-sm"
                [(ngModel)]="report.location"
                placeholder="Localisation"
              />
            </div>
            <div class="input-with-icon">
              <i class="bi bi-calendar-date"></i>
              <input 
                type="date" 
                class="form-input-sm"
                [(ngModel)]="report.date"
              />
            </div>
          </div>
        </div>

        <!-- Sections du rapport -->
        <div class="sections-group">
          <h3 class="sections-title">Sections du Rapport</h3>
          <div class="sections-list">
            <div 
              *ngFor="let section of report.sections; let i = index" 
              class="section-item"
              [class.active]="activeSection === section.id"
              (click)="setActiveSection(section.id)"
            >
              <div class="section-item-content">
                <i [ngClass]="'bi bi-' + getSectionIcon(section.type)"></i>
                <span class="section-item-title">{{ i + 1 }}. {{ section.title }}</span>
              </div>
              <button 
                class="section-delete-btn"
                (click)="deleteSection(section.id); $event.stopPropagation()"
                *ngIf="report.sections.length > 1"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="add-section-buttons">
            <button class="btn btn-sm btn-primary" (click)="addSection('text')">
              <i class="bi bi-plus-circle"></i>
              Texte
            </button>
            <button class="btn btn-sm btn-success" (click)="addSection('chart')">
              <i class="bi bi-bar-chart"></i>
              Résultat
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenu principal -->
    <div class="main-content">
      <div class="main-header">
        <h2 class="main-title">
          {{ getActiveSection()?.title || 'Sélectionner une section' }}
        </h2>
        <div class="main-actions">
          <button class="btn btn-warning" (click)="togglePreview()">
            <i class="bi bi-eye"></i>
            Aperçu
          </button>
          <button class="btn btn-primary" (click)="saveReport()">
            <i class="bi bi-floppy"></i>
            Sauvegarder
          </button>
        </div>
      </div>

      <div class="main-body">
        <div *ngIf="getActiveSection(); else noSelection">
          <!-- Titre de la section -->
          <div class="form-group">
            <label class="form-label">Titre de la Section</label>
            <input 
              type="text" 
              class="form-input"
              [value]="getActiveSection()?.title"
              (input)="onSectionTitleChange(activeSection, $any($event.target).value)"
            />
          </div>

          <!-- Contenu graphique -->
          <div *ngIf="getActiveSection()?.type === 'chart'; else textEditor">
            <div class="form-group">
              <label class="form-label">Type de Graphique</label>
              <select 
                class="form-select"
                [value]="getActiveSection()?.chartData?.type"
                (change)="onChartTypeChange(activeSection, $any($event.target).value)"
              >
                <option *ngFor="let chartType of chartTypes" [value]="chartType.value">
                  {{ chartType.label }}
                </option>
              </select>
            </div>
            
            <div class="chart-config">
              <div class="chart-placeholder-large">
                <button class="btn btn-primary" (click)="configureChartData()">
                  <i class="bi bi-plus"></i>
                  Ajouter un résultat 
                </button>
              </div>
            </div>
          </div>

          <!-- Éditeur de texte -->
          <ng-template #textEditor>
            <div class="form-group">
              <label class="form-label">Contenu</label>
              
              <!-- Barre d'outils de formatage -->
              <div class="formatting-toolbar">
                <!-- Groupe de formatage de base -->
                <div class="toolbar-group">
                  <button 
                    type="button"
                    class="toolbar-btn" 
                    (click)="insertFormatting('bold')"
                    title="Gras (Ctrl+B)"
                  >
                    <i class="bi bi-type-bold"></i>
                  </button>
                  <button 
                    type="button"
                    class="toolbar-btn" 
                    (click)="insertFormatting('italic')"
                    title="Italique (Ctrl+I)"
                  >
                    <i class="bi bi-type-italic"></i>
                  </button>
                  <button 
                    type="button"
                    class="toolbar-btn" 
                    (click)="insertFormatting('underline')"
                    title="Souligné (Ctrl+U)"
                  >
                    <i class="bi bi-type-underline"></i>
                  </button>
                  <button 
                    type="button"
                    class="toolbar-btn" 
                    (click)="insertFormatting('strikethrough')"
                    title="Barré"
                  >
                    <i class="bi bi-type-strikethrough"></i>
                  </button>
                </div>

               
              </div>

              <textarea 
                class="form-textarea"
                [value]="getActiveSection()?.content"
                (input)="onSectionContentChange(activeSection, $any($event.target).value)"
                placeholder="Rédigez le contenu de cette section... Vous pouvez utiliser la barre d'outils pour le formatage."
              ></textarea>
              
            </div>
          </ng-template>
        </div>

        <ng-template #noSelection>
          <div class="no-selection">
            <i class="bi bi-file-earmark-text no-selection-icon"></i>
            <p>Sélectionnez une section pour commencer à rédiger</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>